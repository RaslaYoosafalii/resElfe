<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sales Report</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --accent:#5a5252;
  --muted:#efeeee;
  --brown-text:#6f6766;
  --table-head:#5a5252;
  --soft-border:#e6e3e1;
}

body{
  background:#f9f8f7;
  font-family:'Poppins',sans-serif;
  margin:0;
  color:var(--brown-text);
}

.admin-container{
  margin-left:260px;
  margin-top:110px;
  padding:28px 40px;
}

.page-title{
  font-size:22px;
  font-weight:700;
  margin-bottom:20px;
}

.filter-bar{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:25px;
}

.filter-bar select,
.filter-bar input{
  padding:8px 12px;
  border:1px solid var(--soft-border);
  border-radius:8px;
  font-size:14px;
  background:#fff;
}

.btn{
  background:var(--accent);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}

.btn-light{
  background:#e9e2e0;
  color:var(--accent);
}

.summary-box{
  display:flex;
  gap:20px;
  margin-bottom:25px;
}

.summary-card{
  flex:1;
  background:#efeeee;
  border-radius:12px;
  padding:20px;
}

.summary-card h4{
  margin:0;
  font-weight:500;
  margin-bottom:10px;
}

.summary-card p{
  margin:0;
  font-size:22px;
  font-weight:700;
  color:#6b3e13;
}

.table-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-bottom:10px;
}

.sales-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 12px;
}

.sales-table thead th{
  background:var(--table-head);
  color:#fff;
  padding:14px;
  border-radius:8px 8px 0 0;
  font-size:14px;
  text-align:left;
}

.sales-table tbody td{
  background:#f3f2f2;
  padding:14px;
  font-size:14px;
}

.error{
  color:red;
  margin-bottom:15px;
}
</style>
</head>

<body>

<%- include('../partials/admin/headerSidebar') %>

<div class="admin-container">

<div class="page-title">Sales report</div>

<% if(error){ %>
<div class="error"><%= error %></div>
<% } %>

<form method="GET" action="/admin/sales-report" class="filter-bar">

<label>Report range</label>

<select name="filter" id="filterSelect" required>
  <option value="">Select</option>
  <option value="daily" <%= filter==='daily'?'selected':'' %>>Daily</option>
  <option value="weekly" <%= filter==='weekly'?'selected':'' %>>Weekly</option>
  <option value="monthly" <%= filter==='monthly'?'selected':'' %>>Monthly</option>
  <option value="yearly" <%= filter==='yearly'?'selected':'' %>>Yearly</option>
  <option value="custom" <%= filter==='custom'?'selected':'' %>>Custom</option>
</select>

<input type="date" name="from" id="fromDate"
value="<%= from %>"
style="<%= filter==='custom'?'':'display:none;' %>">

<input type="date" name="to" id="toDate"
value="<%= to %>"
style="<%= filter==='custom'?'':'display:none;' %>">

<% if(applied){ %>
  <a href="/admin/sales-report" class="btn btn-light">Clear</a>
<% } else { %>
  <button type="submit" class="btn">Apply</button>
<% } %>

</form>

<!-- SUMMARY -->
<div class="summary-box">

<div class="summary-card">
  <h4>Total sales</h4>
  <p>Rs. <%= summary.totalSales.toFixed(2) %></p>
</div>

<div class="summary-card">
  <h4>Total orders</h4>
  <p><%= summary.totalOrders %></p>
</div>

<div class="summary-card">
  <h4>Total items sold</h4>
  <p><%= summary.totalOrderItemsSold %></p>
</div>

<div class="summary-card">
  <h4>Total discount</h4>
  <p>Rs. <%= (summary.totalCouponDiscount + summary.totalMrpDiscount).toFixed(2) %></p>
</div>

</div>


<!-- DOWNLOAD BUTTONS -->
<% if(applied){ %>
<div class="table-actions">
  <a href="/admin/sales-report/download?type=excel&filter=<%= filter %>&from=<%= from %>&to=<%= to %>" class="btn btn-light">Excel</a>
  <a href="/admin/sales-report/download?type=pdf&filter=<%= filter %>&from=<%= from %>&to=<%= to %>" class="btn btn-light">PDF</a>
</div>
<% } %>

<!-- TABLE -->
<table class="sales-table">

<thead>
<tr>
<th>Order ID</th>
<th>Customer</th>
<th>Date</th>
<th>Total MRP</th>
<th>Discount on MRP</th>
<th>Coupon discount</th>
<th>Final amount</th>
<th>Payment</th>
</tr>
</thead>

<tbody>

<% if(orders.length){ %>

<% orders.forEach(order => { 
let mrp=0;
let mrpDiscount=0;
order.orderedItem.forEach(item => {

if (["cancelled","returned","failed"].includes(item.orderStatus)) {
  return;
}

const unitMrp = typeof item.basePrice === "number"
  ? item.basePrice
  : (item.price || 0);

const mrpTotal = unitMrp * item.quantity;

const discountedTotal = Number(item.offerPrice || 0);

mrp += mrpTotal;

const discountValue = mrpTotal - discountedTotal;

if (!isNaN(discountValue) && discountValue > 0) {
  mrpDiscount += discountValue;
}

});

%>

<tr>
<td><%= order.orderId %></td>
<td><%= order.userId?.name || 'N/A' %></td>
<td><%= new Date(order.orderDate).toLocaleDateString("en-GB") %></td>
<td>Rs. <%= mrp.toFixed(2) %></td>
<td>Rs. <%= mrpDiscount.toFixed(2) %></td>
<td>Rs. <%= (order.discount||0).toFixed(2) %></td>
<td>Rs. <%= order.finalPrice.toFixed(2) %></td>
<td><%= order.paymentMethod.toUpperCase() %></td>
</tr>

<% }) %>

<% } else { %>
<tr>
<td colspan="8" style="text-align:center;">No sales data</td>
</tr>
<% } %>

</tbody>
</table>

</div>

<%- include('../partials/admin/footer') %>

<script>
const filterSelect = document.getElementById("filterSelect");
const fromInput = document.getElementById("fromDate");
const toInput = document.getElementById("toDate");

filterSelect.addEventListener("change", function(){
  if(this.value === "custom"){
    fromInput.style.display="inline-block";
    toInput.style.display="inline-block";
  }else{
    fromInput.style.display="none";
    toInput.style.display="none";
  }
});
</script>

</body>
</html>
