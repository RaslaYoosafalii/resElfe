<%- include('../partials/admin/headerSidebar') %>

<div class="main-content">

  <style>
    .edit-container {
      background: #fff;
      padding: 35px;
      border-radius: 18px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      max-width: 1100px;
      margin: auto;
    }

    .page-title {
      font-size: 26px;
      font-weight: 600;
      color: #776e65;
      margin-bottom: 25px;
    }

    .form-label {
      font-weight: 500;
      color: #555;
    }

    input, select, textarea {
      border-radius: 10px !important;
    }

    textarea { height: 120px; }

    /* IMAGES */
    .existing-images {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .existing-image-box {
      width: 130px;
      text-align: center;
    }

    .existing-image-box img {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #ddd;
      margin-bottom: 6px;
    }

    #addedImages img {
      width: 120px;
      border-radius: 10px;
      margin-right: 8px;
      border: 1px solid #ddd;
    }

    /* CROPPER */
    .cropper-wrapper {
      width: 300px;
      height: 400px;
      display: none;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #ddd;
      background: #fafafa;
      margin-bottom: 15px;
    }

    #imagePreview {
      max-width: 100%;
      max-height: 100%;
    }

    /* VARIANTS */
    .variant-title {
      font-size: 20px;
      font-weight: 600;
      color: #6f665f;
      margin-top: 30px;
      margin-bottom: 15px;
    }

    .variant-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto auto;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .remove-variant {
      background: #e9e4df;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .remove-variant:hover {
      background: #d5cec8;
    }

    /* BUTTONS */
    #addImageBtn,
    #addVariantBtn {
      background: #b6ada4;
      border: none;
      padding: 8px 20px;
      border-radius: 10px;
      color: #fff;
      margin-bottom: 15px;
      cursor: pointer;
    }

    .submit-btn {
      background: #776e65;
      padding: 12px 26px;
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 17px;
      float: right;
      margin-top: 25px;
    }
  </style>

  <div class="edit-container">

    <h2 class="page-title">Edit Product</h2>

    <% if (message) { %>
      <div class="alert alert-danger"><%= message %></div>
    <% } %>

    <form id="editForm" action="/admin/product/edit/<%= product._id %>" method="POST">
         <input type="hidden" name="_method" value="PUT">


      <!-- NAME -->
      <div class="mb-3">
        <label class="form-label">Product Name</label>
        <input type="text" name="productName" class="form-control" value="<%= product.productName %>" required>
      </div>

      <!-- DESCRIPTION -->
      <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea name="description" class="form-control" required><%= product.description %></textarea>
      </div>

      <div class="row">
        <!-- CATEGORY -->
        <div class="col-md-6 mb-3">
          <label class="form-label">Category</label>
          <select name="categoryId" id="categorySelect" class="form-control" required>
            <% categories.forEach(c => { %>
              <option value="<%= c._id %>" <%= String(c._id) === String(product.categoryId) ? 'selected' : '' %>>
                <%= c.name %>
              </option>
            <% }) %>
          </select>
        </div>

        <!-- SUBCATEGORY -->
        <div class="col-md-6 mb-3">
          <label class="form-label">Subcategory</label>
<select name="subcategoryId" id="subcategorySelect" class="form-control" required>
  <option value="">Select</option>
</select>

        </div>
      </div>

      <!-- EXISTING IMAGES -->
      <label class="form-label">Existing Images</label>
      <div class="existing-images">
        <% product.images.forEach(img => { %>
          <div class="existing-image-box">
            <img src="/uploads/products/<%= img %>">
            <div>
              <input type="checkbox" class="keep-img" value="<%= img %>" checked>
              <small>Keep</small>
            </div>
          </div>
        <% }) %>
      </div>

      <!-- ADD NEW IMAGES -->
      <input type="file" id="imageInput" accept="image/*" hidden>
      <button type="button" id="triggerInputBtn" class="btn btn-outline-secondary mb-2">
        Add New Image
      </button>

      <div class="cropper-wrapper">
        <img id="imagePreview">
      </div>

      <button type="button" id="addImageBtn">Add Image</button>
      <div id="addedImages"></div>

      <!-- VARIANTS -->
      <div class="variant-title">Variants</div>
      <div id="variantsWrap">

        <% variants.forEach(v => { %>
          <div class="variant-row">
            <input type="hidden" class="v-id" value="<%= v._id %>">
            <input class="form-control v-size" value="<%= v.size %>" placeholder="Size">
            <input class="form-control v-color" value="<%= v.color %>" placeholder="Color">
            <input class="form-control v-price" value="<%= v.price %>" type="number">
            <input class="form-control v-discount" value="<%= v.discountPrice ?? '' %>" type="number">
            <input class="form-control v-stock" value="<%= v.stock %>" type="number">
            <label><input type="checkbox" class="v-delete"> Delete</label>
          </div>
        <% }) %>

      </div>

      <button type="button" id="addVariantBtn">Add Variant</button>

      <button class="submit-btn" type="submit">Save Changes</button>
    </form>
  </div>
</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  let cropper;
  const input = document.getElementById('imageInput');
  const preview = document.getElementById('imagePreview');
  const addedImages = document.getElementById('addedImages');
  const imagesBlobs = [];

  document.getElementById('triggerInputBtn').onclick = () => input.click();

  input.onchange = e => {
    document.querySelector('.cropper-wrapper').style.display = 'block';
    const file = e.target.files[0];
    if (!file) return;
    preview.src = URL.createObjectURL(file);
    if (cropper) cropper.destroy();
    cropper = new Cropper(preview, { aspectRatio: 1, viewMode: 1 });
  };

  document.getElementById('addImageBtn').onclick = () => {
    if (!cropper) return alert('Crop image first');
    cropper.getCroppedCanvas({ width: 1200, height: 1200 }).toBlob(blob => {
      const name = `prod-${Date.now()}.jpg`;
      imagesBlobs.push({ blob, name });
      const img = document.createElement('img');
      img.src = URL.createObjectURL(blob);
      addedImages.appendChild(img);
      cropper.destroy();
      cropper = null;
      preview.src = '';
      input.value = '';
      document.querySelector('.cropper-wrapper').style.display = 'none';
    }, 'image/jpeg', 0.9);
  };

  document.getElementById('addVariantBtn').onclick = () => {
    const row = document.createElement('div');
    row.className = 'variant-row';
    row.innerHTML = `
      <input class="form-control v-size" placeholder="Size">
      <input class="form-control v-color" placeholder="Color">
      <input class="form-control v-price" type="number">
      <input class="form-control v-discount" type="number">
      <input class="form-control v-stock" type="number">
      <button type="button" class="remove-variant">Remove</button>
    `;
    row.querySelector('.remove-variant').onclick = () => row.remove();
    document.getElementById('variantsWrap').appendChild(row);
  };

  document.getElementById('editForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);

    const keep = [];
    document.querySelectorAll('.keep-img:checked').forEach(cb => keep.push(cb.value));
    fd.append('existingImagesKeep', JSON.stringify(keep));

    const variants = [];
    document.querySelectorAll('.variant-row').forEach(r => {
      const data = {
        _id: r.querySelector('.v-id')?.value,
        size: r.querySelector('.v-size')?.value,
        color: r.querySelector('.v-color')?.value,
        price: r.querySelector('.v-price')?.value,
        discountPrice: r.querySelector('.v-discount')?.value,
        stock: r.querySelector('.v-stock')?.value,
        _delete: r.querySelector('.v-delete')?.checked
      };
      variants.push(data);
    });
    fd.append('variants', JSON.stringify(variants));

    imagesBlobs.forEach(o => fd.append('productImages', o.blob, o.name));

   const res = await fetch(e.target.action, { method: 'PUT', body: fd });
    if (res.redirected) location.href = res.url;
    else document.write(await res.text());
  });
</script>
<script>
  const ALL_SUBCATEGORIES = <%- JSON.stringify(subcategories) %>;
  const CURRENT_CATEGORY_ID = "<%= product.categoryId %>";
  const CURRENT_SUBCATEGORY_ID = "<%= product.subcategoryId %>";
</script>
<script>
  const categorySelect = document.getElementById('categorySelect');
  const subcategorySelect = document.getElementById('subcategorySelect');

  function populateSubcategories(categoryId, selectedSubId = null) {
    subcategorySelect.innerHTML = '<option value="">Select</option>';

    ALL_SUBCATEGORIES
      .filter(s => String(s.Category) === String(categoryId))
      .forEach(s => {
        const opt = document.createElement('option');
        opt.value = s._id;
        opt.textContent = s.fitName;

        if (selectedSubId && String(s._id) === String(selectedSubId)) {
          opt.selected = true;
        }

        subcategorySelect.appendChild(opt);
      });
  }

  // ðŸ”¹ initial load (important!)
  if (CURRENT_CATEGORY_ID) {
    populateSubcategories(CURRENT_CATEGORY_ID, CURRENT_SUBCATEGORY_ID);
  }

  // ðŸ”¹ when category changes
  categorySelect.addEventListener('change', function () {
    populateSubcategories(this.value, null);
  });
</script>


<%- include('../partials/admin/footer') %>
