<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin - Categories</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* =========================
       PAGE LAYOUT
    ========================== */
    .main-content {
      background: #f9f8f7;
    }

    h2.page-title {
      font-weight: 500;
      color: #444;
      margin-bottom: 25px;
    }

    /* =========================
       ADD CATEGORY
    ========================== */
    .add-category-box {
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      margin-bottom: 25px;
    }

    .add-category-box h5 {
      font-weight: 500;
      margin-bottom: 15px;
      color: #555;
    }

    .add-category-form {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .add-category-form input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    .btn-primary-custom {
      background: #6c645c;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-primary-custom:hover {
      background: #59524b;
    }

    /* =========================
       SEARCH BAR
    ========================== */
    .search-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .search-bar input {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    .btn-outline {
      border: 1px solid #ccc;
      background: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-outline:hover {
      background: #f0eeec;
    }

    /* =========================
       CATEGORY TABLE
    ========================== */
    .category-table {
      background: #fff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background: #f4f2f0;
    }

    th, td {
      padding: 14px 16px;
      vertical-align: top;
      color: #444;
    }

    th {
      font-weight: 500;
      font-size: 13px;
      text-transform: capitalize;
      color: #666;
    }

    tbody tr:not(:last-child) {
      border-bottom: 1px solid #eee;
    }

    .muted {
      font-size: 12px;
      color: #999;
    }

    /* =========================
       SUBCATEGORIES
    ========================== */
    .sub-list {
      padding-left: 18px;
      margin-bottom: 8px;
    }

    .sub-list li {
      margin-bottom: 6px;
      font-size: 13px;
    }

    .sub-actions button {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .btn-edit {
      background: #eae8e6;
    }

    .btn-delete {
      background: #e74c3c;
      color: #fff;
    }

    .add-sub-form input {
      width: 100%;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 6px;
    }

    /* =========================
       ACTION BUTTONS
    ========================== */
    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .btn-list {
      background: #6c645c;
      color: #fff;
    }

    .btn-unlist {
      background: #c0392b;
      color: #fff;
    }

    /* =========================
       PAGINATION
    ========================== */
    .pagination-box {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
    }

    .pagination-box a {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      text-decoration: none;
      font-size: 13px;
      color: #555;
    }

    .pagination-box a.active {
      background: #6c645c;
      color: #fff;
      border-color: #6c645c;
    }

    /* =========================
       MESSAGE
    ========================== */
    .notice {
      background: #fff;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #aaa;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <%- include('../partials/admin/headerSidebar') %>

  <div class="main-content">

    <h2 class="page-title">Category Management</h2>

    <% if (message) { %>
      <div class="notice" id="flashMessage"><%= message %></div>
    <% } %>

    <!-- ADD CATEGORY -->
    <div class="add-category-box">
      <h5>Add new category</h5>
      <form method="POST" action="/admin/category/create" class="add-category-form">
        <input name="name" placeholder="Enter category name" required>
        <input name="description" placeholder="Enter description" required>
        <button class="btn-primary-custom" type="submit">+ Add category</button>
      </form>
    </div>

    <!-- SEARCH -->
    <div class="search-bar">
      <form id="searchForm" method="GET" action="/admin/category" style="display:flex; gap:10px;">
        <input type="text" name="q" placeholder="Search categories"
          value="<%= pagination.q || '' %>">
        <input type="hidden" name="limit" value="<%= pagination.limit %>">
        <button class="btn-outline" type="submit">Search</button>
        <button id="clearSearch" type="button" class="btn-outline">Clear</button>
      </form>

      <form method="GET" action="/admin/category" style="margin-left:auto;">
        <input type="hidden" name="q" value="<%= pagination.q || '' %>">
        <select name="limit" onchange="this.form.submit()">
          <option value="5" <%= pagination.limit==5?'selected':'' %>>5</option>
          <option value="10" <%= pagination.limit==10?'selected':'' %>>10</option>
          <option value="20" <%= pagination.limit==20?'selected':'' %>>20</option>
        </select>

          <button
    type="button"
    class="btn-outline"
    onclick="location.href='/admin/category/deleted'">
    Deleted Categories
  </button>
      </form>
    </div>

    <!-- TABLE -->
    <div class="category-table">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Subcategories</th>
            <th>Products</th>
            <th>Offer</th>
            <th>Listed</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
        <% categories.forEach(cat => { %>
          <tr>
            <td>
              <strong><%= cat.name %></strong><br>
              <span class="muted">Created: <%= new Date(cat.createdAt).toLocaleDateString() %></span>
            </td>

            <td><%= cat.description %></td>

            <td>
              <% if (cat.subcategories.length) { %>
                <ul class="sub-list">
                  <% cat.subcategories.forEach(sc => { %>
                    <li>
                      <%= sc.fitName %>
                      <div class="sub-actions">
                        <button data-action="edit-sub" data-id="<%= sc._id %>" class="btn-edit">Edit</button>
                        <button data-action="delete-sub" data-id="<%= sc._id %>" class="btn-delete">Delete</button>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              <% } else { %>
                <span class="muted">No subcategories</span>
              <% } %>

              <form method="POST" action="/admin/category/subcreate" class="add-sub-form">
                <input type="hidden" name="categoryId" value="<%= cat._id %>">
                <input name="fitName" placeholder="Add subcategory" required>
                <button class="btn-sm btn-edit">Add</button>
              </form>
            </td>

            <td><%= cat.productCount %></td>

            <td>
              <% if (cat.offerPrice > 0) { %>
                <strong><%= cat.offerIsPercent ? cat.offerPrice + '%' : 'â‚¹' + cat.offerPrice %></strong>
                <div class="muted"><%= cat.offerValidDate ? new Date(cat.offerValidDate).toLocaleDateString() : '' %></div>
                <form method="POST" action="/admin/category/offer/<%= cat._id %>">
                  <button class="btn-sm">Clear</button>
                </form>
              <% } else { %>
                <form method="POST" action="/admin/category/offer/<%= cat._id %>">
                  <select name="offerType">
                    <option value="fixed">Fixed</option>
                    <option value="percent">Percent</option>
                  </select>
                  <input name="offerValue" placeholder="Value">
                  <input type="date" name="offerValidDate">
                  <button class="btn-sm btn-edit">Set</button>
                </form>
              <% } %>
            </td>

            <td><%= cat.isListed ? 'Yes' : 'No' %></td>

            <td>
              <form method="POST" action="/admin/category/toggle/<%= cat._id %>" style="display:inline;">
                <button class="btn-sm <%= cat.isListed ? 'btn-unlist' : 'btn-list' %>">
                  <%= cat.isListed ? 'Unlist' : 'List' %>
                </button>
              </form>
              <button data-action="edit-cat" data-id="<%= cat._id %>" class="btn-sm btn-edit">Edit</button>
              <button data-action="delete-category" data-id="<%= cat._id %>" class="btn-sm btn-delete">Delete</button>
            </td>
          </tr>
        <% }) %>
        </tbody>
      </table>
    </div>

    <% if (pagination.totalPages > 1) { %>
      <div class="pagination-box">
        <% for(let p=1;p<=pagination.totalPages;p++){ %>
          <a class="<%= p===pagination.page?'active':'' %>"
             href="/admin/category?page=<%=p%>&limit=<%=pagination.limit%>&q=<%=pagination.q||''%>">
             <%= p %>
          </a>
        <% } %>
      </div>
    <% } %>

  </div>

  <%- include('../partials/admin/footer') %>

  <!-- KEEP YOUR EXISTING JS (UNCHANGED) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // helper POST JSON
    async function postJson(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data || {})
      });
      return res.json();
    }

    // Clear search button behaviour
    document.getElementById('clearSearch').addEventListener('click', function () {
      const form = document.getElementById('searchForm');
      form.q.value = '';
      form.submit();
    });

    // click handler for edit/delete actions
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!id) return;

      // ----------------- DELETE CATEGORY -----------------
      if (action === 'delete-category') {
        Swal.fire({
          title: 'Delete category?',
          text: 'This will delete the category and all its subcategories.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, delete',
          cancelButtonText: 'Cancel'
        }).then(async (result) => {
          if (!result.isConfirmed) return;
          try {
            const json = await postJson('/admin/category/delete/' + id);
            if (json.success) {
              Swal.fire('Deleted', json.message, 'success').then(() => location.reload());
            } else {
              Swal.fire('Error', json.message || 'Failed to delete', 'error');
            }
          } catch (err) {
            Swal.fire('Error', 'Network or server error', 'error');
          }
        });
        return;
      }

      // ----------------- DELETE SUBCATEGORY -----------------
      if (action === 'delete-sub') {
        Swal.fire({
          title: 'Delete subcategory?',
          text: 'This will delete the subcategory. This action cannot be undone.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, delete',
          cancelButtonText: 'Cancel'
        }).then(async (result) => {
          if (!result.isConfirmed) return;
          try {
            const json = await postJson('/admin/category/subdelete/' + id);
            if (json.success) {
              Swal.fire('Deleted', json.message, 'success').then(() => location.reload());
            } else {
              Swal.fire('Error', json.message || 'Failed to delete', 'error');
            }
          } catch (err) {
            Swal.fire('Error', 'Network or server error', 'error');
          }
        });
        return;
      }

      // ----------------- EDIT CATEGORY (modal) -----------------
      if (action === 'edit-cat') {
        // fetch category + subs
        fetch('/admin/category/data/' + id)
          .then(r => r.json())
          .then(data => {
            if (!data.success) return Swal.fire('Error', data.message || 'Failed to fetch data', 'error');
            const cat = data.category;
            // show modal with inputs for name, description, isListed
            Swal.fire({
              title: 'Edit Category',
              html:
                `<input id="sw-name" class="sw-input" placeholder="Name" value="${escapeHtml(cat.name)}" style="width:100%;padding:8px;margin-bottom:8px;" />` +
                `<textarea id="sw-desc" class="sw-input" placeholder="Description" style="width:100%;padding:8px;">${escapeHtml(cat.description || '')}</textarea>` +
                `<div style="margin-top:8px;">Listed: <select id="sw-listed"><option value="true">Yes</option><option value="false">No</option></select></div>`,
              didOpen: () => { document.getElementById('sw-listed').value = cat.isListed ? 'true' : 'false'; },
              showCancelButton: true,
              preConfirm: () => {
                const name = document.getElementById('sw-name').value.trim();
                const description = document.getElementById('sw-desc').value.trim();
                const isListed = document.getElementById('sw-listed').value;
                if (!name || !description) {
                  Swal.showValidationMessage('Name and description are required');
                  return false;
                }
                return { name, description, isListed };
              }
            }).then(async (result) => {
              if (!result.isConfirmed) return;
              const body = result.value;
              // call edit endpoint
              try {
                const json = await postJson('/admin/category/edit/' + id, body);
                if (json.success) {
                  Swal.fire('Saved', json.message || 'Category updated', 'success').then(() => location.reload());
                } else {
                  Swal.fire('Error', json.message || 'Failed to update', 'error');
                }
              } catch (err) {
                Swal.fire('Error', 'Network error', 'error');
              }
            });
          }).catch(err => {
            Swal.fire('Error', 'Failed to fetch category', 'error');
          });
        return;
      }

      // ----------------- EDIT SUBCATEGORY (modal) -----------------
      if (action === 'edit-sub') {

        fetch('/admin/category/subdata/' + id)
          .then(r => r.json())
          .then(data => {
            if (!data.success) return Swal.fire('Error', data.message || 'Failed to fetch subcategory', 'error');
            const sub = data.subcategory;
            Swal.fire({
              title: 'Edit Subcategory',
              html: `<input id="sw-subname" class="sw-input" placeholder="Subcategory name" value="${escapeHtml(sub.fitName)}" style="width:100%;padding:8px;" />`,
              showCancelButton: true,
              preConfirm: () => {
                const fitName = document.getElementById('sw-subname').value.trim();
                if (!fitName) { Swal.showValidationMessage('Name required'); return false; }
                return { fitName };
              }
            }).then(async (result) => {
              if (!result.isConfirmed) return;
              try {
                const json = await postJson('/admin/category/subedit/' + id, { fitName: result.value.fitName });
                if (json.success) {
                  Swal.fire('Saved', json.message || 'Subcategory updated', 'success').then(() => location.reload());
                } else {
                  Swal.fire('Error', json.message || 'Failed to update', 'error');
                }
              } catch (err) {
                Swal.fire('Error', 'Network error', 'error');
              }
            });
          }).catch(err => Swal.fire('Error', 'Failed to fetch subcategory', 'error'));
        return;
      }

    }); // document click

    // escape helper for strings in HTML (XSS safe)
    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
  </script>
  <script>
  const flash = document.getElementById('flashMessage');
  if (flash) {
    setTimeout(() => {
      flash.style.opacity = '0';
      flash.style.transition = 'opacity 0.4s ease';
      setTimeout(() => flash.remove(), 400);
    }, 1000); // 3 seconds
  }
</script>

</body>
</html>
