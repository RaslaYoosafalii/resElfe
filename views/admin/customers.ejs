<%- include('../partials/admin/headerSidebar') %>

<div class="main-content">

  <style>
    /* ===== SAME CSS (unchanged except spacing safety) ===== */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
    }

    .page-header h2 {
      font-size: 24px;
      font-weight: 600;
      color: #555;
    }

    .search-wrap {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-wrap input {
      border-radius: 12px;
      padding: 8px 14px;
      border: 1px solid #ddd;
      width: 240px;
    }

    .filter-btn {
      border: 1px solid #ddd;
      background: #fff;
      padding: 8px 14px;
      border-radius: 12px;
      color: #777;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .table-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      padding: 15px;
    }

    thead th {
      background: #5f5751;
      color: #fff;
      padding: 14px;
      font-weight: 500;
      text-align: left;
      white-space: nowrap;
    }

    thead th:last-child,
    tbody td:last-child {
      text-align: center;
    }

    tbody tr {
      background: #f6f5f4;
    }

    tbody td {
      padding: 14px;
      color: #555;
      vertical-align: middle;
    }

    .customer-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #cfc9c3;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
    }

    .status-active {
      color: #1ea672;
      border: 1px solid #1ea672;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
    }

    .status-blocked {
      color: #ff5a5a;
      border: 1px solid #ff5a5a;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
    }

    .action-btn {
      border: none;
      background: none;
      font-size: 18px;
      cursor: pointer;
      margin: 0 6px;
    }

    .action-delete { color: #888; }
    .action-toggle { color: #1ea672; }
    .blocked .action-toggle { color: #ff5a5a; }

    .pagination-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 25px;
    }

    .pagination {
      display: flex;
      gap: 8px;
    }

    .pagination a {
      padding: 6px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      color: #777;
      text-decoration: none;
    }

    .pagination a.active {
      background: #e7e5ff;
      color: #6b63ff;
      border-color: transparent;
    }

    .limit-select {
      border-radius: 8px;
      padding: 4px 8px;
    }
  </style>

  <!-- HEADER -->
  <div class="page-header">
    <h2>Customer</h2>

    <form class="search-wrap" id="searchForm" method="GET" action="/admin/customer">
      <input
        type="text"
        name="q"
        placeholder="Search"
        value="<%= pagination?.q || '' %>"
      >
      <input type="hidden" name="limit" value="<%= pagination?.limit || 10 %>">

      <button type="submit" class="filter-btn">
        <i class="bi bi-search"></i>
      </button>

      <button type="button" id="clearSearch" class="filter-btn">
        Clear
      </button>
    </form>
  </div>

  <!-- TABLE -->
  <div class="table-card">
    <table>
      <thead>
        <tr>
          <th>Customer</th>
          <th>Email</th>
          <th>Customer ID</th>
          <th>Orders</th>
          <th>Balance</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <% if (customers && customers.length) { %>
          <% customers.forEach(c => { %>
            <tr class="<%= c.isBlocked ? 'blocked' : '' %>">
              <td>
                <div class="customer-info">
                  <div class="avatar"><%= c.name.charAt(0).toUpperCase() %></div>
                  <%= c.name %>
                </div>
              </td>
              <td><%= c.email %></td>
              <td><%= c.customerId %></td>
              <td><%= c.orderCount %></td>
              <td>$<%= c.wallet.toFixed(2) %></td>
              <td>
                <span class="<%= c.isBlocked ? 'status-blocked' : 'status-active' %>">
                  <%= c.isBlocked ? 'Blocked' : 'Active' %>
                </span>
              </td>
              <td>
                <!-- BLOCK / UNBLOCK -->
                <form
                  method="POST"
                  action="/admin/customer/toggle/<%= c._id %>"
                  class="toggle-form"
                  data-id="<%= c._id %>"
                  style="display:inline"
                >
                  <button class="action-btn action-toggle" type="submit">
                    <i class="bi <%= c.isBlocked ? 'bi-x-circle' : 'bi-check-circle' %>"></i>
                  </button>
                </form>

                <!-- DELETE -->
                <button
                  class="action-btn action-delete delete-btn"
                  data-id="<%= c._id %>"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="7" style="text-align:center">No customers found</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  <% if (pagination && pagination.totalPages > 1) { %>
    <div class="pagination-wrap">
      <div>
        Show result:
        <form method="GET" action="/admin/customer" style="display:inline">
          <input type="hidden" name="q" value="<%= pagination.q || '' %>">
          <select name="limit" class="limit-select" onchange="this.form.submit()">
            <option value="5" <%= pagination.limit==5?'selected':'' %>>5</option>
            <option value="10" <%= pagination.limit==10?'selected':'' %>>10</option>
            <option value="20" <%= pagination.limit==20?'selected':'' %>>20</option>
          </select>
        </form>
      </div>

      <div class="pagination">
        <% if (pagination.page > 1) { %>
          <a href="?page=<%= pagination.page-1 %>&limit=<%= pagination.limit %>&q=<%= pagination.q || '' %>">&lt;</a>
        <% } %>

        <% for (let p=1; p<=pagination.totalPages; p++) { %>
          <a class="<%= p===pagination.page?'active':'' %>"
             href="?page=<%= p %>&limit=<%= pagination.limit %>&q=<%= pagination.q || '' %>">
            <%= p %>
          </a>
        <% } %>

        <% if (pagination.page < pagination.totalPages) { %>
          <a href="?page=<%= pagination.page+1 %>&limit=<%= pagination.limit %>&q=<%= pagination.q || '' %>">&gt;</a>
        <% } %>
      </div>
    </div>
  <% } %>

</div>

<%- include('../partials/admin/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  
async function sendRequest(url, method) {
  const res = await fetch(url, {
    method,
    headers: { Accept: 'application/json' },
    credentials: 'same-origin'
  });
  return res.json();
}



  /* CLEAR SEARCH */
  document.getElementById('clearSearch').onclick = () => {
    window.location.href = '/admin/customer';
  };

  /* BLOCK / UNBLOCK */
  document.querySelectorAll('.toggle-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const id = form.dataset.id;
      const blocked = form.closest('tr').classList.contains('blocked');

      const result = await Swal.fire({
        title: blocked ? 'Unblock user?' : 'Block user?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: blocked ? 'Unblock' : 'Block'
      });

      if (!result.isConfirmed) return;

     const json = await sendRequest('/admin/customer/' + id + '/block', 'PATCH');
      if (json.success) location.reload();
      else Swal.fire('Error', json.message || 'Action failed', 'error');
    });
  });

  /* DELETE USER */
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;

      const result = await Swal.fire({
        title: 'Delete customer?',
        text: 'This action cannot be undone',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Delete',
        confirmButtonColor: '#d33'
      });

      if (!result.isConfirmed) return;

      const json = await sendRequest('/admin/customer/' + id, 'DELETE');
      if (json.success) {
        Swal.fire('Deleted', 'Customer removed', 'success').then(() => location.reload());
      } else {
        Swal.fire('Error', json.message || 'Delete failed', 'error');
      }
    });
  });
</script>
<script>
  window.addEventListener('pageshow', function (event) {
    if (event.persisted) {
      window.location.reload();
    }
  });
</script>
