<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Order Details</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent:#5a5252;
      --muted:#efeeee;
      --brown-text:#6f6766;
      --soft-border:#e6e3e1;
      --card-bg:#f3f2f2;
    }

    body {
      background:#f9f8f7;
      font-family:'Poppins',sans-serif;
      margin:0;
      color:var(--brown-text);
    }

    .admin-container {
      margin-left:260px;
      margin-top:110px;
      padding:28px 40px;
    }

    .page-title {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:25px;
    }

    h2 {
      margin:0;
      font-size:22px;
      font-weight:700;
    }

    .card {
      background:var(--card-bg);
      padding:20px;
      border-radius:12px;
      margin-bottom:22px;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:18px;
    }

    .label {
      font-size:13px;
      color:#7f7776;
      margin-bottom:4px;
    }

    .value {
      font-size:15px;
      font-weight:500;
    }

    .status {
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
      text-transform:capitalize;
    }

    .pending { background:#fff3cd; color:#856404; }
    .confirmed { background:#e2e3ff; color:#383d7a; }
    .shipped { background:#d1ecf1; color:#0c5460; }
    .delivered { background:#d4edda; color:#155724; }
    .cancelled { background:#f8d7da; color:#721c24; }

    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
    }

    thead th {
      text-align:left;
      padding:12px 16px;
      background:var(--accent);
      color:#fff;
      font-size:14px;
    }

    tbody td {
      padding:14px 16px;
      background:#fff;
      font-size:14px;
      vertical-align:middle;
    }

    .product {
      display:flex;
      gap:12px;
      align-items:center;
    }

    .product img {
      width:52px;
      height:52px;
      border-radius:8px;
      object-fit:cover;
      border:1px solid #ddd;
    }

    .back-btn {
      background:var(--accent);
      color:#fff;
      padding:8px 14px;
      border-radius:8px;
      text-decoration:none;
      font-weight:600;
      font-size:14px;
    }
  </style>
</head>

<body>

<%- include('../partials/admin/headerSidebar') %>

<div class="admin-container">

  <div class="page-title">
    <h2>Order Details</h2>
    <a href="/admin/order" class="back-btn">← Back</a>
  </div>
 <!-- ORDER ITEMS -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Size</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% order.orderedItem.forEach(item => { %>
          <tr>
            <td>
              <div class="product">
                <% if (item.productImages?.length) { %>
                  <img src="/uploads/products/<%= item.productImages[0] %>">
                <% } %>
                <div><%= item.productName %></div>
              </div>
            </td>
            <td>  <%= item.size %></td>
            <td>  <%= item.quantity %></td>
<td>
  <% if (item.couponShare > 0) { %>
    <div style="text-decoration:line-through;color:#888;">
      ₹ <%= item.price %>
    </div>
    ₹ <%= item.price - item.couponShare %>
  <% } else { %>
    ₹ <%= item.price %>
  <% } %>
</td>

<td>
  <% const itemTotalAfterCoupon = item.offerPrice - (item.couponShare || 0); %>
  ₹ <%= itemTotalAfterCoupon %>
</td>

            <td>
              <span class="status <%= item.orderStatus %>">
                <%= item.orderStatus %>
              </span>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <!-- ORDER SUMMARY -->
  <div class="card grid">
    <div>
      <div class="label">Order ID</div>
      <div class="value"><%= order.orderId %></div>
    </div>

    <div>
      <div class="label">Order Date</div>
      <div class="value">
        <%= new Date(order.orderDate).toLocaleString("en-GB") %>
      </div>
    </div>

<div>
  <div class="label">Order Status</div>
  <div class="value">
    <%
  const flow = ['pending','shipped','out for delivery','delivered'];
  const currentStatus = order.orderStatus;
  const currentStatusIndex = flow.indexOf(currentStatus);
%>

<select
  id="orderStatusSelect"
  data-id="<%= order._id %>"
  data-current="<%= order.orderStatus %>"
>

<% ['pending','shipped','out for delivery','delivered','cancelled','returned'].forEach(s => {
     let disabled = false;

     // forward-only, one-step rule
     if (flow.includes(currentStatus) && flow.includes(s)) {
       disabled =
         flow.indexOf(s) !== currentStatusIndex + 1 &&
         s !== currentStatus;
     }

     // cancellation allowed only from pending
     if (s === 'cancelled' && currentStatus !== 'pending') {
       disabled = true;
     }
      
     // once delivered or cancelled nothing else selectable
     if (['delivered','cancelled','returned'].includes(currentStatus) && s !== currentStatus) {
       disabled = true;
     }
     if (s === 'returned') disabled = true;

%>

  <option
    value="<%= s %>"
    <%= currentStatus === s ? 'selected' : '' %>
    <%= disabled ? 'disabled' : '' %>>
    <%= s %>
  </option>

<% }) %>

    </select>
  </div>
</div>


    <div>
      <div class="label">Payment</div>
      <div class="value">
<%
  const displayPaymentStatus =
    order.orderStatus === 'cancelled' &&
    order.paymentStatus === 'pending'
      ? 'not paid'
      : order.paymentStatus;
%>

<%= order.paymentMethod %> — <%= displayPaymentStatus %>
      </div>
    </div>
  </div>

  <!-- CUSTOMER DETAILS -->
  <div class="card grid">
    <div>
      <div class="label">Customer Name</div>
      <div class="value"><%= order.userId?.name || 'N/A' %></div>
    </div>

    <div>
      <div class="label">Email</div>
      <div class="value"><%= order.userId?.email || 'N/A' %></div>
    </div>

    <div>
      <div class="label">Mobile</div>
      <div class="value"><%= order.userId?.mobileNumber || 'N/A' %></div>
    </div>
  </div>

  <!-- SHIPPING ADDRESS -->
  <div class="card">
    <div class="label">Shipping Address</div>
    <div class="value">
      <%= order.address.name %>, <%= order.address.address %>,<br>
      <%= order.address.locality %>, <%= order.address.city %>,<br>
      <%= order.address.state %> - <%= order.address.pincode %><br>
      Phone: <%= order.address.mobileNumber %>
    </div>
  </div>



  <!-- PRICE SUMMARY -->
<%
const activeOrderItems = order.orderedItem.filter(
    i => !["cancelled", "returned"].includes(i.orderStatus)
  );

  const returnedItems = order.orderedItem.filter(
    i => i.orderStatus === "returned"
  );

  const cancelledItems = order.orderedItem.filter(
    i => i.orderStatus === "cancelled"
  );

  // ===== ACTIVE SUMMARY =====
 const totalMRP = activeOrderItems.reduce(
    (sum, i) => sum + (i.basePrice * i.quantity),
    0
  );

  const totalOfferPrice = activeOrderItems.reduce(
    (sum, i) => sum + i.offerPrice,
    0
  );

const totalCouponDiscount = activeOrderItems.reduce(
    (sum, i) => sum + (i.couponShare || 0),
    0
  );

  const discountOnMRP = totalMRP - totalOfferPrice;

  const finalAmount =
    activeOrderItems.length > 0
      ? (totalOfferPrice - totalCouponDiscount + order.shippingCharge)
      : 0;

  // ===== REFUND SUMMARY =====
  const returnedAmount = returnedItems.reduce(
    (sum, i) => sum + (i.offerPrice - (i.couponShare || 0)),
    0
  );

  const cancelledAmount = cancelledItems.reduce(
    (sum, i) => sum + (i.offerPrice - (i.couponShare || 0)),
    0
  );
%>


<div class="card grid">

  <div>
    <div class="label">Total MRP</div>
    <div class="value">₹ <%= totalMRP %></div>
  </div>

  <div>
    <div class="label">Discount on MRP</div>
    <div class="value">₹ <%= discountOnMRP > 0 ? discountOnMRP : 0 %></div>
  </div>

  <div>
    <div class="label">Coupon Discount</div>
    <div class="value">₹ <%= totalCouponDiscount %></div>
  </div>

  <div>
    <div class="label">Shipping</div>
    <div class="value">₹ <%= activeOrderItems.length > 0 ? order.shippingCharge : 0 %></div>
  </div>

  <div>
    <div class="label">Final Amount</div>
    <div class="value"><strong>₹ <%= finalAmount %></strong></div>
  </div>

</div>
<% if (order.paymentMethod !== "cod" && (returnedAmount > 0 || cancelledAmount > 0)) { %>

<div class="card grid">

  <div style="grid-column: 1 / -1;">
    <div class="label" style="font-weight:600;">Refund Summary</div>
  </div>

  <% if (returnedAmount > 0) { %>
    <div>
      <div class="label">Returned Amount</div>
      <div class="value" style="color:#155724;">
        ₹ <%= returnedAmount %>
      </div>
    </div>
  <% } %>

  <% if (cancelledAmount > 0) { %>
    <div>
      <div class="label">Cancelled Amount</div>
      <div class="value" style="color:#721c24;">
        ₹ <%= cancelledAmount %>
      </div>
    </div>
  <% } %>

</div>

<% } %>



</div>

<%- include('../partials/admin/footer') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const select = document.getElementById("orderStatusSelect");

if (select) {
  select.addEventListener("change", async () => {
    const orderId = select.dataset.id;
    const prev = select.dataset.current;
    const next = select.value;

    const result = await Swal.fire({
      title: "Change order status?",
      text: `${prev} → ${next}`,
      icon: "warning",
      showCancelButton: true
    });

    if (!result.isConfirmed) {
      select.value = prev;
      return;
    }

    const res = await fetch(`/admin/order/status/${orderId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: next })
    });

    const json = await res.json();

if (json.success) {
  Swal.fire({
    icon: "success",
    title: "Status Updated",
    showConfirmButton: false,
    timer: 1200
  }).then(() => location.reload());
}
else {
  Swal.fire("Error", json.message, "error");
  select.value = prev;
}
  });
}
</script>

</body>
</html>
