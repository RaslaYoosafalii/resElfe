<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Confirm with OTP</title>

  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --accent:#5a5252;
      --muted:#f6f6f6;
      --card-bg:#fff;
      --shadow: 0 20px 40px rgba(0,0,0,0.06);
      --text-muted:#7b6f6f;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;color:#222;background:#fff}
    body{display:flex;align-items:center;justify-content:center;padding:40px 20px}

    .card{
      width:86vw; max-width:1100px;
      border-radius:28px;
      padding:72px 120px;
      background:var(--card-bg);
      box-shadow:var(--shadow);
    }

    h1{
      font-family:'Lora',serif;
      font-size:56px;
      margin:0 0 18px;
      text-align:center;
      color:#0f0f0f;
    }

    .lead{
      max-width:680px;
      margin:0 auto 18px;
      text-align:center;
      font-size:16px;
      color:#1f1f1f;
      font-weight:400;
    }

    .otp-row{display:flex;justify-content:center;gap:18px;margin-top:18px}
    .otp-input{
      width:64px;height:64px;border-radius:12px;border:2px solid #e0e0e0;background:#f6f6f6;font-size:20px;text-align:center;
      outline:none;padding:6px;line-height:1;
    }

    .otp-input:focus{box-shadow:0 0 0 4px rgba(90,82,82,0.04);border-color:#d0cfcf}

    .btn{
      width:55%;max-width:560px;padding:16px 20px;border-radius:26px;background:var(--accent);color:#fff;font-weight:700;border:none;font-size:20px;margin:26px auto 0;display:block;cursor:pointer;
    }

    .help-row{margin-top:30px;text-align:center;color:var(--text-muted)}
    .help-row button{background:none;border:none;color:inherit;cursor:pointer;text-decoration:underline;font-size:16px}

    .back-link{margin-top:72px;text-align:center;color:var(--text-muted)}

    @media (max-width:780px){
      .card{padding:48px 24px;border-radius:18px}
      .otp-input{width:56px;height:56px}
      .btn{width:92%}
      h1{font-size:40px}
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Confirm with OTP</h1>
    <p class="lead">Please check your mail address for OTP</p>

    <% if (typeof message !== 'undefined' && message) { %>
      <script>
        document.addEventListener('DOMContentLoaded', ()=> {
          Swal.fire({ icon: 'info', title: 'Notice', text: "<%= message.replace(/"/g, '\\"') %>" });
        });
      </script>
    <% } %>

    <form id="otpForm" method="POST" action="/forgot-verify" style="text-align:center;">
      <div class="otp-row" role="group" aria-label="OTP inputs">
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="o1" name="o1" autocomplete="one-time-code" />
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="o2" name="o2" autocomplete="one-time-code" />
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="o3" name="o3" autocomplete="one-time-code" />
        <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input" id="o4" name="o4" autocomplete="one-time-code" />
      </div>

      <input type="hidden" name="email" value="<%= typeof email !== 'undefined' ? email : '' %>" />
      <button class="btn" type="submit">Confirm</button>
    </form>

    <div class="help-row">
      <!-- we will replace this button text with countdown when disabled -->
      <button id="resendBtn" type="button">Resend OTP</button>
    </div>

    <div class="back-link">
      <a href="/login" style="color:inherit;text-decoration:none;">Go back to Login page</a>
    </div>
  </div>

  <script>
    const inputs = Array.from(document.querySelectorAll('.otp-input'));
    const resendBtn = document.getElementById('resendBtn');
    const emailHidden = document.querySelector('input[name="email"]');
    let resendTimer = null;
    const RESEND_SECONDS = 60;

    // Auto-advance, backspace, paste support
    inputs.forEach((input, idx) => {
      input.addEventListener('input', (e) => {
        const val = e.target.value.replace(/\D/g,'');
        e.target.value = val;
        if (val && idx < inputs.length - 1) inputs[idx+1].focus();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) {
          inputs[idx-1].focus();
        }
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,4);
        paste.split('').forEach((ch, i) => {
          if (inputs[i]) inputs[i].value = ch;
        });
      });
    });

    // On submit, combine digits into single field 'otp'
    document.getElementById('otpForm').addEventListener('submit', function(e){
      const combined = inputs.map(i => i.value || '').join('');
      if (combined.length < 4) {
        e.preventDefault();
        Swal.fire({ icon:'error', title:'Invalid OTP', text:'Please enter the 4-digit OTP.' });
        return;
      }
      const hidden = document.createElement('input');
      hidden.type = 'hidden'; hidden.name = 'otp'; hidden.value = combined;
      this.appendChild(hidden);
    });

    // Start a 60s countdown; used on initial load and after each successful resend
    function startResendCountdown(seconds) {
      let remaining = seconds;
      resendBtn.disabled = true;
      updateResendText(remaining);

      clearInterval(resendTimer);
      resendTimer = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          clearInterval(resendTimer);
          resendBtn.disabled = false;
          resendBtn.textContent = 'Resend OTP';
        } else {
          updateResendText(remaining);
        }
      }, 1000);
    }

    function updateResendText(sec) {
      resendBtn.textContent = `Resend OTP (${sec}s)`;
    }

    // If page loaded and email present, start countdown to prevent immediate resend
    document.addEventListener('DOMContentLoaded', () => {
      const email = emailHidden.value || '';
      if (email) {
        // start initial countdown so user can't spam resend right away
        startResendCountdown(RESEND_SECONDS);
      }
    });

    // Resend OTP - AJAX with 60s cooldown
    resendBtn.addEventListener('click', async () => {
      const email = emailHidden.value || '';
      if (!email) {
        Swal.fire({ icon:'error', title:'Error', text:'Email missing. Start over.' });
        return;
      }

      resendBtn.disabled = true;

      try {
        const res = await fetch('/forgot-resend-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        // try parse JSON response
        let data;
        try {
          data = await res.json();
        } catch (err) {
          throw new Error('Invalid server response');
        }

        if (res.ok && data?.success) {
          // show friendly human-readable message
          Swal.fire({ icon:'success', title:'OTP Sent', text: data.message || 'OTP resent successfully.' });
          // restart countdown
          startResendCountdown(RESEND_SECONDS);
        } else {
          // server returned failure
          Swal.fire({ icon:'error', title:'Failed', text: data?.message || 'Could not resend OTP.' });
          // re-enable button so user can try again
          resendBtn.disabled = false;
          resendBtn.textContent = 'Resend OTP';
        }
      } catch (err) {
        // network or parse error
        Swal.fire({ icon:'error', title:'Server error', text:'Unable to resend OTP. Please try again later.' });
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend OTP';
      }
    });
  </script>
</body>
</html>
