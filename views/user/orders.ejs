<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin:0; background:#fff; color:#222; }

.container {
  max-width:1200px;
  margin:40px auto;
  padding:0 20px;
}

.page-title {
  font-size:28px;
  margin-bottom:25px;
}

/* SEARCH */
.search-box {
  margin-bottom:25px;
  display:flex;
  gap:10px;
}
.search-box input {
  flex:1;
  padding:10px 14px;
  border-radius:25px;
  border:1px solid #ccc;
}
.search-box button {
  padding:10px 20px;
  border-radius:25px;
  border:none;
  background:#222;
  color:#fff;
  cursor:pointer;
}

/* ORDER CARD */
.order-card {
  border:1px solid #ddd;
  border-radius:12px;
  padding:20px;
  margin-bottom:20px;
}

.order-header {
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:10px;
}

.order-id {
  font-weight:bold;
}

.status {
  padding:5px 14px;
  border-radius:20px;
  font-size:13px;
  background:#eee;
}

.status.delivered { background:#d4f5d4; }
.status.cancelled { background:#ffd6d6; }
.status.pending { background:#fff3cd; }

.order-meta {
  margin-top:10px;
  font-size:14px;
  color:#555;
}

/* ITEMS */
.item {
  display:flex;
  gap:12px;
  margin-top:15px;
}
.item img {
  width:70px;
  height:90px;
  object-fit:cover;
  border-radius:6px;
}

/* ACTIONS */
.actions {
  margin-top:15px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.btn {
  padding:8px 18px;
  border-radius:20px;
  border:none;
  cursor:pointer;
  font-size:14px;
}

.btn-dark { background:#222; color:#fff; }
.btn-outline {
  background:#fff;
  border:1px solid #222;
}

/* MODAL */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:1000;
}

.modal-content {
  background:#fff;
  max-width:700px;
  margin:50px auto;
  border-radius:10px;
  padding:25px;
  max-height:85vh;
  overflow:auto;
}

.close-btn {
  float:right;
  font-size:20px;
  cursor:pointer;
  border:none;
  background:none;
}
textarea {
  width:100%;
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
  resize:none;
}
.pagination {
  display:flex;
  justify-content:center;
  gap:10px;
  margin:40px 0;
}

.page-btn {
  padding:8px 14px;
  border-radius:20px;
  border:1px solid #ccc;
  text-decoration:none;
  color:#222;
  font-size:14px;
}

.page-btn:hover {
  background:#f2f2f2;
}

.page-btn.active {
  background:#222;
  color:#fff;
  border-color:#222;
}
/* ===== MATCH PROFILE LAYOUT ===== */
.profile-wrapper {
  display: flex;
  padding: 40px 60px;
  gap: 40px;
  align-items: flex-start; 
}


.profile-card {
  flex: 1;
  background: #fff;
  border-radius: 12px;
  padding: 40px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  min-height: 520px; 
  display: flex;        
  flex-direction: column;  
}
/* Centered empty-search message */
#noResultsMsg {
  margin-top: auto; 
  padding-top: 90px;
  text-align: center;
  font-size: 16px;
  color: #666;
}
.orders-content {
  flex: 1; /* ✅ pushes pagination to bottom */
  display: flex;              /* ✅ ADD */
  flex-direction: column;     /* ✅ ADD */
}

.pagination {
  margin-top: auto;   /* ✅ THIS pushes it to the bottom */
}


/* RESPONSIVE – same as profile */
@media (max-width: 900px) {
  .profile-wrapper {
    flex-direction: column;
    padding: 20px;
  }

  .sidebar {
    width: 100%;
  }

  .profile-card {
    padding: 25px;
  }
}



</style>
</head>

<body>

<%- include('../partials/user/loggedinHeader') %>
<div class="profile-wrapper">

  <!-- SIDEBAR -->
  <%- include('../partials/user/profileSidebar') %>

  <!-- MAIN CONTENT -->
  <section class="profile-card">
 <div class="orders-content">   
    <div class="page-title">My Orders</div>

    <!-- SEARCH -->
    <div class="search-box">
      <input type="text" id="searchOrder" placeholder="Search by Order ID">
      <button onclick="searchOrder()">Search</button>
      <button id="clearSearch" onclick="clearSearch()" style="display:none">
        Clear
      </button>

    </div>
<p id="noResultsMsg" style="display:none;color:#666;margin-top:20px;">
No orders found matching your search.
</p>

    <% if (!orders || orders.length === 0) { %>
      <p>No orders found.</p>
    <% } %>

<!--  -->
  <% orders.forEach(order => { %>
    <div class="order-card" data-orderid="<%= order.orderId %>">
      <div class="order-header">
        <div class="order-id">Order ID: <%= order.orderId %></div>
        <div class="status <%= order.orderStatus %>"><%= order.orderStatus %></div>
      </div>

      <div class="order-meta">
        Ordered on: <%= new Date(order.orderDate).toLocaleDateString() %><br>
        Total: ₹<%= order.finalPrice %>
      </div>

      <% order.orderedItem.forEach(item => { %>
        <div class="item">
          <img src="/uploads/products/<%= item.productImages[0] %>">
          <div>
            <strong><%= item.productName %></strong><br>
            Qty: <%= item.quantity %> | ₹<%= item.offerPrice %><br>
            Status:   <% if (item.orderStatus === 'rejected') { %>
    Return request rejected (Delivered)
  <% } else { %>
    <%= item.orderStatus %>
  <% } %>
          </div>
        </div>
      <% }) %>

      <div class="actions">
        <button class="btn btn-outline" onclick="viewDetails('<%= order.orderId %>')">Details</button>
        <button class="btn btn-outline" onclick="downloadInvoice('<%= order.orderId %>')">Dowload Invoice</button>

        <%
const hasNonCancelableItem = order.orderedItem.some(i =>
  ['delivered', 'returnRequested', 'returned'].includes(i.orderStatus)
);
%>

        <% if (!hasNonCancelableItem && order.orderStatus !== 'cancelled') { %>
          <button class="btn btn-dark" onclick="cancelOrder('<%= order.orderId %>')">Cancel Order</button>
        <% } %>
      </div>
    </div>
  <% }) %>
  <!--  -->
 </div>
<!-- MODAL -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">✕</button>
    <div id="modalBody"></div>
  </div>
</div>
<!-- pagination -->
<div class="pagination">
  <% for(let i=1;i<=totalPages;i++){ %>
    <a href="/orders?page=<%= i %>"
       class="page-btn <%= i===currentPage ? 'active' : '' %>">
      <%= i %>
    </a>
  <% } %>
</div>

  </section>
</div>





<%- include('../partials/user/footer') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function searchOrder() {
  const input = document.getElementById('searchOrder');
  const val = input.value.trim();
  const clearBtn = document.getElementById('clearSearch');
  const noResults = document.getElementById('noResultsMsg');

  let visibleCount = 0;

  document.querySelectorAll('.order-card').forEach(card => {
    if (card.dataset.orderid.includes(val)) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });

  clearBtn.style.display = val ? 'inline-block' : 'none';

  // ✅ Show search-specific empty message
  noResults.style.display = val && visibleCount === 0 ? 'block' : 'none';

  // ✅ Disable pagination only when search has no results
  togglePagination(!(val && visibleCount === 0));
}



function clearSearch() {
  document.getElementById('searchOrder').value = '';
  document.querySelectorAll('.order-card').forEach(c => c.style.display='block');
  document.getElementById('clearSearch').style.display = 'none';
  document.getElementById('noResultsMsg').style.display = 'none';

  togglePagination(true); // ✅ re-enable pagination
}


function cancelOrder(orderId) {
  Swal.fire({
    title: 'Cancel Order?',
    input: 'textarea',
    inputPlaceholder: 'Reason (optional)',
    showCancelButton: true,
    confirmButtonText: 'Cancel Order'
  }).then(res => {
    if (!res.isConfirmed) return;
    fetch('/orders/cancel', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ orderId, reason: res.value || "" })
    })
    .then(r=>r.json())
    .then(d=>{
      if(d.success){
        Swal.fire('Cancelled','Order cancelled successfully','success')
          .then(()=>location.reload());
      } else {
        Swal.fire('Error',d.message,'error');
      }
    });
  });
}

function returnOrder(orderId) {
  Swal.fire({
    title:'Return Order',
    input:'textarea',
    inputPlaceholder:'Reason (mandatory)',
    showCancelButton:true,
    confirmButtonText:'Request Return',
    preConfirm:value=>{
      if(!value || !value.trim()){
        Swal.showValidationMessage('Return reason required');
      }
      return value;
    }
  }).then(res=>{
    if(!res.isConfirmed) return;
    fetch('/orders/return',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ orderId, reason: res.value })
    })
    .then(r=>r.json())
    .then(d=>{
      if(d.success){
        Swal.fire('Requested','Return request submitted','success')
          .then(()=>location.reload());
      } else {
        Swal.fire('Error',d.message,'error');
      }
    });
  });
}

function viewDetails(orderId){
  fetch(`/orders/${orderId}`)
    .then(r=>r.text())
    .then(html=>{
      document.getElementById('modalBody').innerHTML = html;
      document.getElementById('detailModal').style.display='block';
    });
}

function closeModal(){
  document.getElementById('detailModal').style.display='none';
}

function downloadInvoice(orderId){
  window.open(`/orders/invoice/${orderId}`, '_blank');
}

function togglePagination(show) {
  const pagination = document.querySelector('.pagination');
  if (!pagination) return;

  pagination.style.pointerEvents = show ? 'auto' : 'none';
  pagination.style.opacity = show ? '1' : '0.4';
}

</script>
<script>
window.cancelItem = function(orderId, productId) {
  Swal.fire({
    title: 'Cancel this item?',
    input: 'textarea',
    inputPlaceholder: 'Reason (optional)',
    showCancelButton: true,
    confirmButtonText: 'Cancel Item'
  }).then(res => {
    if (!res.isConfirmed) return;

    fetch('/orders/cancel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId,
        productId,
        reason: res.value || ''
      })
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        Swal.fire('Cancelled', 'Item cancelled successfully', 'success')
          .then(() => location.reload());
      } else {
        Swal.fire('Error', d.message || 'Unable to cancel item', 'error');
      }
    });
  });
};



window.returnItem = function(orderId, productId){
  Swal.fire({
    title:'Return this item',
    input:'textarea',
    inputPlaceholder:'Reason (mandatory)',
    showCancelButton:true,
    confirmButtonText:'Request Return',
    preConfirm:v=>{
      if(!v || !v.trim()){
        Swal.showValidationMessage('Return reason required');
      }
      return v;
    }
  }).then(res=>{
    if(!res.isConfirmed) return;

    fetch('/orders/return-item',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ orderId, productId, reason: res.value })
    })
    .then(r=>r.json())
    .then(d=>{
      if(d.success){
        Swal.fire('Requested','Return requested','success')
          .then(()=>location.reload());
      } else {
        Swal.fire('Error',d.message || 'Unable to return item','error');
      }
    });
  });
};

window.cancelReturn = function(orderId, productId){
  fetch('/orders/cancel-return', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ orderId, productId })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      Swal.fire('Cancelled','Return request cancelled','success')
        .then(()=>location.reload());
    } else {
      Swal.fire('Error',d.message || 'Unable to cancel return','error');
    }
  });
};

</script>
<script>
(function autoOpenOrderModal() {
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get('open');

  if (!orderId) return;

  // Load order details into modal
  fetch(`/orders/${orderId}`)
    .then(res => {
      if (!res.ok) throw new Error('Order not found');
      return res.text();
    })
    .then(html => {
      document.getElementById('modalBody').innerHTML = html;
      document.getElementById('detailModal').style.display = 'block';

      // Push clean /orders URL (no ?open=) so BACK works correctly
      history.replaceState({}, '', '/orders');
    })
    .catch(() => {
      console.warn('Unable to auto-open order modal');
    });
})();
</script>

</body>
</html>
