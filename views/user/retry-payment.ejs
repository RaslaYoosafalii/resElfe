<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Retry Payment</title>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<script>
const options = {
  key: "<%= key %>",
  amount: <%= order.finalPrice * 100 %>,
  currency: "INR",
  name: "ELFE LOREINVEIL",
  description: "Retry Payment",
  order_id: "<%= razorpayOrderId %>",

  handler: function (response) {
fetch('/order/verify-payment', {
  method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        razorpay_order_id: response.razorpay_order_id,
        razorpay_payment_id: response.razorpay_payment_id,
        razorpay_signature: response.razorpay_signature,
        orderId: "<%= order.orderId %>"
      })
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        window.location.href = "/order/success/<%= order.orderId %>";
      } else {
        window.location.href = "/order/failure/<%= order.orderId %>";
      }
    });
  },

  modal: {
    ondismiss: function () {
      window.location.href = "/order/failure/<%= order.orderId %>";
    }
  }
};

const rzp = new Razorpay(options);
rzp.open();
</script>
<script>
history.replaceState(null,null,location.href);
window.onpopstate = function(){
  window.location.href = '/orders';
};
</script>
</body>
</html>
