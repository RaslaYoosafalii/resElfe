<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Change Password</title>

  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --accent:#5a5252;
      --muted:#f6f6f6;
      --card-bg:#fff;
      --shadow: 0 20px 40px rgba(0,0,0,0.06);
      --text-muted:#7b6f6f;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial;color:#222;background:#fff}
    body{display:flex;align-items:center;justify-content:center;padding:40px 20px}

    .card{
      width:86vw; max-width:1100px;
      border-radius:28px;
      padding:72px 120px;
      background:var(--card-bg);
      box-shadow:var(--shadow);
    }

    h1{font-family:'Lora',serif;font-size:56px;margin:0 0 18px;text-align:center;color:#0f0f0f;}
    .lead{max-width:680px;margin:0 auto 18px;text-align:center;font-size:16px;color:#1f1f1f;font-weight:400;}

    form{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:8px}
    .inp{width:55%;max-width:560px;padding:18px;border-radius:14px;border:2px solid #dedede;background:#f6f6f6;font-size:16px;outline:none;}
    .btn{width:55%;max-width:560px;padding:16px;border-radius:26px;background:var(--accent);color:#fff;font-weight:700;border:none;font-size:20px;margin-top:6px;cursor:pointer;}
    .link-row{margin-top:72px;text-align:center;color:var(--text-muted)}
    @media (max-width:780px){ .card{padding:48px 24px;border-radius:18px} .inp, .btn { width:92% } h1{font-size:40px} }
  </style>
</head>
<body>
  <div class="card">
    <h1>Change Password</h1>
    <p class="lead">Please confirm your password</p>

    <% if (typeof message !== 'undefined' && message) { %>
      <script>
        document.addEventListener('DOMContentLoaded', ()=> {
          Swal.fire({ icon: 'info', title: 'Notice', text: "<%= message.replace(/"/g, '\\"') %>" });
        });
      </script>
    <% } %>

    <form id="changeForm" method="POST" action="/change-password" novalidate>
      <input class="inp" name="newPassword" type="password" placeholder="New password" required />
      <input class="inp" name="confirmPassword" type="password" placeholder="Confirm Password" required />
      <button class="btn" id="changeBtn" type="submit">Change Password</button>
    </form>

    <div class="link-row">
      <a href="/login" style="color:inherit;text-decoration:none;">Go back to Login page</a>
    </div>
  </div>

  <script>
    document.getElementById('changeForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const newP = this.newPassword.value.trim();
      const cP = this.confirmPassword.value.trim();

      if (!newP || !cP) {
        Swal.fire({ icon:'error', title:'Missing fields', text:'Please fill both password fields.'});
        return;
      }
      if (newP !== cP) {
        Swal.fire({ icon:'error', title:'Mismatch', text:'Passwords do not match.'});
        return;
      }
      if (newP.length < 6) {
        Swal.fire({ icon:'error', title:'Weak password', text:'Password should be at least 6 characters.'});
        return;
      }

      const changeBtn = document.getElementById('changeBtn');
      changeBtn.disabled = true;

      try {
        const res = await fetch('/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword: newP, confirmPassword: cP })
        });

        const data = await res.json();
        if (res.ok && data?.success) {
          await Swal.fire({ icon:'success', title:'Success', text: data.message || 'Password changed successfully' });
          // redirect to login
          window.location.href = data.redirectUrl || '/login';
        } else {
          Swal.fire({ icon:'error', title:'Failed', text: data?.message || 'Failed to change password' });
        }
      } catch (err) {
        Swal.fire({ icon:'error', title:'Server error', text:'Unable to change password. Please try again later.' });
      } finally {
        changeBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
