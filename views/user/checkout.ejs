<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

body {
  margin: 0;
  background: #fff;
  color: #333;
}

.container {
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
}

.checkout-title {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 25px;
}

/* LAYOUT */
.checkout-layout {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 30px;
}

/* ADDRESS */
.address-box {
  border: 1px solid #ddd;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 25px;
}

.address-item {
  border: 1px solid #eee;
  padding: 14px;
  border-radius: 6px;
  margin-bottom: 12px;
  display: flex;
  gap: 12px;
}

.address-item input {
  margin-top: 4px;
}

.address-actions {
  margin-top: 12px;
}

.btn {
  padding: 10px 18px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
}

.btn-dark {
  background: #222;
  color: white;
}

.btn-outline {
  background: white;
  border: 1px solid #222;
}

/* PRODUCTS */
.product-row {
  display: flex;
  gap: 12px;
  margin-bottom: 15px;
}

.product-row img {
  width: 70px;
  height: 90px;
  object-fit: cover;
  border-radius: 6px;
}

/* SUMMARY */
.summary-box {
  border: 1px solid #ddd;
  padding: 20px;
  border-radius: 8px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
}

.place-btn {
  margin-top: 15px;
  width: 100%;
  padding: 14px;
  background: black;
  color: white;
  border: none;
  border-radius: 30px;
  font-size: 15px;
  cursor: pointer;
}
 /* ===== MAIN CARD ===== */
    .profile-card {
      flex: 1;
      background: #fff;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }

    .profile-title {
      text-align: center;
      font-size: 28px;
      letter-spacing: 2px;
      margin-bottom: 40px;
    }

    /* ===== FORM ===== */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full {
      grid-column: span 2;
    }

    .form-group label {
      font-size: 14px;
      color: #555;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      background: #f5f5f5;
    }

    textarea {
      resize: none;
      height: 80px;
    }

    /* ===== RADIO ===== */
    .radio-group {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-top: 10px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    .error-text {
    color: red;
    font-size: 12px;
    display: none;
    }

    /* ===== ACTIONS ===== */
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 40px;
    }

    .btn-save {
      background: #5a5553;
      color: #fff;
      border: none;
      padding: 8px 22px;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-cancel {
      background: #fff;
      color: #333;
      border: 1px solid #aaa;
      padding: 8px 22px;
      border-radius: 6px;
      cursor: pointer;
    }
 
  .error-text {
    color: red;
    font-size: 12px;
    display: none;
  }

</style>
</head>

<body>

<%- include('../partials/user/loggedinHeader') %>

<div class="container">
  <div class="checkout-title">Checkout</div>
<!-- BREADCRUMBS -->
<nav style="margin-bottom:20px;font-size:14px;">
  <a href="/cart" style="color:#555;text-decoration:none;">Cart</a>
  <span style="margin:0 6px;">â€º</span>
  <strong>Checkout</strong>
</nav>
  <div class="checkout-layout">
 
    <div>
      <!-- ADDRESS -->
      <div class="address-box">
        <h3>Select Delivery Address</h3>
        
<% addresses.address.forEach((a, i) => { %>
  <div class="address-item">
    <input 
      type="radio"
      name="addressId"
      value="<%= i %>"
      <%= i === 0 ? 'checked' : '' %>
    >
    <div>
      <strong><%= a.name %></strong><br>
      <%= a.address %>, <%= a.locality %>, <%= a.city %><br>
      <%= a.state %> - <%= a.pincode %><br>
      ðŸ“ž <%= a.mobileNumber %>
    </div>
  </div>
<% }) %>

<button class="btn btn-outline" onclick="openAddAddressModal()">
  Add New Address
</button>

  <button class="btn btn-outline" onclick="editSelectedAddress()">
    Edit Address
  </button>
</div>

      </div>
      <!-- PRODUCTS -->
      <div class="address-box">
        <h3>Order Items</h3>

        <% cart.items.forEach(item => { %>
          <div class="product-row">
           <img src="<%= item.productImage  ? '/uploads/products/' + item.productImage  : '/images/placeholder.png' %>">
            <div>
              <strong><%= item.productName %></strong><br>
              Size: <%= item.size %> | Qty: <%= item.quantity %><br>
              Rs. <%= item.totalPrice %>
            </div>
          </div>
        <% }) %>
      </div>

      <!-- PAYMENT -->
      <div class="address-box">
        <h3>Payment Method</h3>
        <label>
          <input type="radio" checked>
          Cash on Delivery
        </label>
      </div>

    </div>

    <!-- RIGHT -->
    <div>
      <div class="summary-box">
        <h3>Price Summary</h3>

        <div class="summary-row">
          <span>MRP Total</span>
          <span>Rs. <%= summary.baseTotal %></span>
        </div>

        <div class="summary-row">
          <span>Discount</span>
          <span>-<%= summary.discountPct %>%</span>
        </div>

        <div class="summary-row">
          <span>Shipping</span>
          <span>Free</span>
        </div>

        <div class="summary-row">
          <strong>Payable</strong>
          <strong>Rs. <%= summary.finalTotal %></strong>
        </div>

        <button class="place-btn" onclick="placeOrder()">Place Order</button>
      </div>
    </div>

  </div>
</div>

<!-- ADD ADDRESS MODAL -->
<div id="addAddressModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:1000;
">
  <div style="
    background:#fff;
    max-width:700px;
    margin:40px auto;
    border-radius:8px;
    padding:25px;
    position:relative;
    max-height:90vh;
    overflow:auto;
  ">

    <button onclick="closeAddAddressModal()"
      style="position:absolute;top:10px;right:15px;border:none;background:none;font-size:20px;cursor:pointer">
      âœ•
    </button>


 <form id="addAddressForm" novalidate>
    <section class="profile-card">
      <h2 class="profile-title">ADD NEW ADDRESS</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Name</label>
            <input type="text" name="name" placeholder="Enter your name" required >
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Mobile Number</label>
            <input type="text" name="mobileNumber" inputmode="numeric" pattern="[0-9]*" placeholder="Enter your Mobile number" required oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <span class="error-text">Enter valid 10 digit number</span>
          </div>

          <div class="form-group">
            <label>Pincode</label>
            <input type="number" name="pincode" inputmode="numeric" pattern="[0-9]*" placeholder="Enter your pincode" required >
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Locality</label>
            <input type="text" name="locality" placeholder="Enter your locality" required >
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group full">
            <label>Address</label>
            <textarea name="address" placeholder="Address (area, city)" required ></textarea>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>City/Dist/Town</label>
            <input type="text" name="city" placeholder="Enter city/dist/town" required >
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>State</label>
            <select name="state" required >
              <option value="">--- select state ---</option>
              <option value="Kerala">Kerala</option>
              <option value="Tamil Nadu">Tamil Nadu</option>
              <option value="Karnataka">Karnataka</option>
            </select>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Landmark</label>
            <input type="text" name="landmark" placeholder="Enter landmark" required >
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Alternate Mobile Number</label>
            <input type="text" name="alternativeNumber" inputmode="numeric" pattern="[0-9]*" placeholder="Alternate Mobile number (optional)" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <span class="error-text">Enter valid 10 digit number</span>
          </div>

          <div class="form-group full">
            <div class="radio-group">
              <label>
                <input type="radio" name="addressType" value="Home" checked required>
                Home
              </label>
              <label>
                <input type="radio" name="addressType" value="Work">
                Work
              </label>
              <span class="error-text">Required field</span>
            </div>
          </div>

        </div>

               <div class="form-actions">
          <button type="submit" class="btn-save" >Save</button>
          <button type="button" class="btn-cancel" onclick="closeAddAddressModal()">Cancel</button>
        </div>
      </form>
    </section>

  </div>
</div>
<!-- EDIT ADDRESS MODAL -->
<div id="editAddressModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:1000;
">
  <div style="
    background:#fff;
    max-width:700px;
    margin:40px auto;
    border-radius:8px;
    padding:25px;
    position:relative;
    max-height:90vh;
    overflow:auto;
  ">

    <button onclick="closeEditAddressModal()"
      style="position:absolute;top:10px;right:15px;border:none;background:none;font-size:20px;cursor:pointer">
      âœ•
    </button>

    <section class="profile-card">
      <h2 class="profile-title">EDIT ADDRESS</h2>

      <form id="editAddressForm" novalidate>
        <input type="hidden" name="index" id="editAddressIndex">

        <div class="form-grid">

          <div class="form-group">
            <label>Name</label>
            <input type="text" name="name" required>
          </div>

          <div class="form-group">
            <label>Mobile Number</label>
            <input type="text" name="mobileNumber" required
              oninput="this.value=this.value.replace(/[^0-9]/g,'')">
              <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Pincode</label>
            <input type="number" name="pincode" required>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Locality</label>
            <input type="text" name="locality" required>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group full">
            <label>Address</label>
            <textarea name="address" required></textarea>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>City</label>
            <input type="text" name="city" required>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>State</label>
            <select name="state" required>
              <option value="Kerala">Kerala</option>
              <option value="Tamil Nadu">Tamil Nadu</option>
              <option value="Karnataka">Karnataka</option>
            </select>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Landmark</label>
            <input type="text" name="landmark" required>
            <span class="error-text">Required field</span>
          </div>

          <div class="form-group">
            <label>Alternate Mobile Number</label>
            <input type="text" name="alternativeNumber"
              oninput="this.value=this.value.replace(/[^0-9]/g,'')">
          </div>

          <div class="form-group full">
            <div class="radio-group" required>
              <label>
                <input type="radio" name="addressType" value="Home">
                Home
              </label>
              <label>
                <input type="radio" name="addressType" value="Work">
                Work
              </label>
            </div>
          </div>

        </div>

        <div class="form-actions">
          <button type="submit" class="btn-save">Update</button>
          <button type="button" class="btn-cancel" onclick="closeEditAddressModal()">Cancel</button>
        </div>
      </form>
    </section>

  </div>
</div>


<script>
function placeOrder() {
  window.location.href = '/order/success';
}
</script>

<%- include('../partials/user/footer') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function placeOrder() {
  const addressIndex = document.querySelector(
    'input[name="addressId"]:checked'
  )?.value;

  if (addressIndex === undefined) {
    Swal.fire('Select Address', 'Please select a delivery address', 'warning');
    return;
  }

  Swal.fire({
    title: 'Confirm Order',
    text: 'Place order with Cash on Delivery?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Place Order'
  }).then(result => {
    if (!result.isConfirmed) return;

    fetch('/order/place', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ addressIndex })
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        Swal.fire('Error', data.message, 'error');
      } else {
        window.location.href = `/order/success/${data.orderId}`;
      }
    });
  });
}
</script>
<script>
function openAddAddressModal() {
  document.getElementById('addAddressModal').style.display = 'block';
}

function closeAddAddressModal() {
  document.getElementById('addAddressModal').style.display = 'none';
}

document.getElementById('addAddressForm')?.addEventListener('submit', async e => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

 if (!validateAddressForm(form)) {
  Swal.fire(
    'Invalid Address',
    'Please correct the highlighted fields',
    'warning'
  );
  return;
}


  try {
    const res = await fetch('/address/add', {
      method: 'POST',
      body: new URLSearchParams(formData)
    });

    if (!res.ok) {
      throw new Error('Save failed');
    }

    Swal.fire({
      icon: 'success',
      title: 'Address Added',
      text: 'Your address has been saved successfully'
    }).then(() => {
      location.reload(); // reload checkout to show address
    });

  } catch (err) {
    Swal.fire('Error', 'Failed to save address. Try again.', 'error');
  }
});
</script>
<script>
const addresses = <%- JSON.stringify(addresses.address) %>;

function editSelectedAddress() {
  const selected = document.querySelector('input[name="addressId"]:checked');
  if (!selected) {
    Swal.fire('Select Address', 'Please select an address to edit', 'warning');
    return;
  }

  const index = selected.value;
  const a = addresses[index];
  const form = document.getElementById('editAddressForm');

  document.getElementById('editAddressIndex').value = index;

  for (const key in a) {
    if (form[key]) {
      if (form[key].type === 'radio') {
        [...form[key]].forEach(r => r.checked = r.value === a[key]);
      } else {
        form[key].value = a[key] ?? '';
      }
    }
  }

  document.getElementById('editAddressModal').style.display = 'block';
}

function closeEditAddressModal() {
  document.getElementById('editAddressModal').style.display = 'none';
}
</script>

<script>
document.getElementById('editAddressForm')?.addEventListener('submit', async e => {
  e.preventDefault();

  const form = e.target;
  const index = document.getElementById('editAddressIndex').value;

if (!validateAddressForm(form)) {
  Swal.fire(
    'Invalid Address',
    'Please correct the required fields',
    'sad'
  );
  return;
}


  try {
    const res = await fetch(`/address/edit/${index}`, {
      method: 'POST',
      body: new URLSearchParams(new FormData(form))
    });

    if (!res.ok) throw new Error();

    Swal.fire('Updated', 'Address updated successfully', 'success')
      .then(() => location.reload());

  } catch {
    Swal.fire('Error', 'Failed to update address', 'error');
  }
});
</script>

<script>
function validateAddressForm(form) {
  let valid = true;

  const showError = (input, message) => {
    const error = input.closest('.form-group')?.querySelector('.error-text');
    if (error) {
      error.innerText = message;
      error.style.display = 'block';
    }
    valid = false;
  };

  const clearError = input => {
    const error = input.closest('.form-group')?.querySelector('.error-text');
    if (error) error.style.display = 'none';
  };

 
  form.querySelectorAll(
    'input[type="text"][required], textarea[required], select[required], input[type="number"][required]'
  ).forEach(input => {
    clearError(input);
    if (!input.value || input.value.trim() === '') {
      showError(input, 'Required field');
    }
  });

  
  const typeChecked = form.querySelector('input[name="addressType"]:checked');
  const radioGroup = form.querySelector('.radio-group');
  const radioError = radioGroup?.querySelector('.error-text');

  if (!typeChecked && radioError) {
    radioError.style.display = 'block';
    valid = false;
  } else if (radioError) {
    radioError.style.display = 'none';
  }

  const mobile = form.mobileNumber;
  const alt = form.alternativeNumber;
  const pin = form.pincode;

  if (!/^\d{10}$/.test(mobile.value)) {
    showError(mobile, 'Enter valid 10 digit number');
  }

  if (alt.value) {
    if (!/^\d{10}$/.test(alt.value)) {
      showError(alt, 'Enter valid 10 digit number');
    }
    if (alt.value === mobile.value) {
      showError(alt, 'Alternate number must be different');
    }
  }

  /* =========================
     PINCODE
     ========================= */
  if (!/^\d{6}$/.test(pin.value)) {
    showError(pin, 'Enter valid 6 digit pincode');
  }

  return valid;
}
</script>

<script>
function attachLiveValidation(form) {
  form.querySelectorAll('[required]').forEach(input => {

    const error = input.closest('.form-group')?.querySelector('.error-text');
    if (!error) return;

    const validate = () => {
      if (!input.value.trim()) {
        error.style.display = 'block';
      } else {
        error.style.display = 'none';
      }
    };

    input.addEventListener('blur', validate);
    input.addEventListener('input', validate);
  });
}
</script>
<script>
attachLiveValidation(document.getElementById('addAddressForm'));
attachLiveValidation(document.getElementById('editAddressForm'));
</script>

</body>
</html>
